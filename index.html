<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/history.js"></script> <!-- 履歴機能 -->
    <script src="js/create.js"></script> <!-- HTML動的生成機能 -->
    <script src="js/language.js"></script> <!-- 多言語対応機能 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
            https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-analytics.js"></script>

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBHcr2ydRlHzJAifdx5pRjZgGvgaWMmkr8",
            authDomain: "topickpot.firebaseapp.com",
            databaseURL: "https://topickpot.firebaseio.com",
            projectId: "topickpot",
            storageBucket: "topickpot.appspot.com",
            messagingSenderId: "934511938847",
            appId: "1:934511938847:web:03c6196d553838e0a5742a",
            measurementId: "G-FRCZ4E0ESP"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
    </script>

    <title>ToPickPot</title>
</head>

<header>
    <!-- タイトルと説明 -->
    <h1 id='aboutTitle' class='title'>ToPickPot</h1>
    <p id='aboutTopicPot'></p>
</header>

<div class='menuBar'>
    <!-- 言語セレクトフォーム -->
    <p id='aboutLangType'>language</p>
    <select name="selectForm" id="langType" type="texst"></select>

    <!-- 列セレクトフォーム -->
    <p id='aboutColmn'>column</p>
    <select name="selectForm" id="colNum" type="number"></select>

    <!-- 行セレクトフォーム -->
    <p id='aboutRow'>Row</p>
    <select name="selectForm" id="rowNum" type="number"></select>

    <!-- ToPickPotボタン -->
    <button id='createPot'>Let's ToPickPot !!</button>
</div>

<body>
    <!-- ToPickPot表示領域 -->
    <div id='searchPanel' class='searchResult'></div>

    <!-- 検索履歴表示領域 -->
    <h2 id='aboutResent'></h2>

    <!-- 今後の予定表示領域 -->
    <h2 id='aboutSchedule'></h2>
</body>

<footer>
    <hr>
    <table>
        <tr>
            <td>Twitter</td>
            <td>@miniusagi33 </td>
        </tr>
    </table>
</footer>

<script>
    //定数定義
    const COLMAX = 10;
    const ROWMAX = 10;

    //ローカルデータ
    let localData;
    let jsonData;

    //初期設定
    if (localStorage.getItem('localDataJson') === null) {
        //ローカルストレージの初期設定(デフォルトは日本語の3x3)
        localData = {
            lang: '4',
            col: '3',
            row: '3',
        }
        jsonData = JSON.stringify(localData)
        localStorage.setItem('localDataJson', jsonData);
    }
    else {
        //ローカルストレージから読み出し
        jsonData = localStorage.getItem('localDataJson');
        localData = JSON.parse(jsonData);
    }
    //言語セレクトフォーム作成
    createLangForm();
    $('#langType').val(localData.lang);

    //列セレクトフォーム作成
    createColForm(COLMAX);
    $('#colNum').val(localData.col);

    //行セレクトフォーム作成
    createRowForm(ROWMAX);
    $('#rowNum').val(localData.row);


    //言語設定とトピックポット作成
    createToPickPot(localData.lang, localData.col, localData.row);


    // 言語ボタン、列ボタン、行ボタン、変化イベント
    $('#langType,#colNum,#rowNum,#createPot').change('click', function () {

        let colNum = $('#colNum').val();
        let rowNum = $('#rowNum').val();
        let langNo = $('#langType').val();

        //言語設定とトピックポット作成
        createToPickPot(langNo, colNum, rowNum);
    });

    // トピックポットボタン押下イベント
    $('#createPot').on('click', function () {

        let colNum = $('#colNum').val();
        let rowNum = $('#rowNum').val();
        let langNo = $('#langType').val();

        //言語設定とトピックポット作成
        createToPickPot(langNo, colNum, rowNum);
    });





    //トピックリンククリックイベント
    $('#searchPanel a').on('click', function (e) {
        console.log('searchPanelの子孫のa');

        let topic = $(this).text();
        let lang = $('#langType').val();
        console.log(topic);

        //firestoreにデータを送信

        const db = firebase.firestore().collection('topickpot');

        // db.doc(topic).get().then(function (doc) {
        //     console.log(doc);
        // })


        // const dataObject = {
        //     topic: topic,
        //     lang: lang,
        //     time: firebase.firestore.FieldValue.serverTimestamp(),
        //     connt: 0,
        // }
        // db.doc(topic).set(dataObject);


        db.doc(topic).get().then(function (doc) {
            console.log('ok')
            if (doc.exists) {
                //データが取得できたときの処理
                console.log("Document data:", doc.data());
                const dataObject = {
                    topic: topic,
                    lang: lang,
                    time: firebase.firestore.FieldValue.serverTimestamp(),
                    connt: 1,
                }

            } else {
                // doc.data() will be undefined in this case
                console.log("No such document!");
                const dataObject = {
                    topic: topic,
                    lang: lang,
                    time: firebase.firestore.FieldValue.serverTimestamp(),
                    connt: 1,
                }
                db.doc(topic).set(dataObject);
            }
        }).catch(function (error) {
            console.log("Error getting document:", error);
        });



        // return false;
        // e.preventDefault();

    });



</script>

</html>